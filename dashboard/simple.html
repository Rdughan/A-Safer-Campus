<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safer Campus - Safety Intelligence</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #7f8c8d;
            font-size: 1.2rem;
            margin-bottom: 20px;
        }

        .setup-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .setup-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"], input[type="url"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus, input[type="url"]:focus {
            outline: none;
            border-color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn-success {
            background: #27ae60;
        }

        .btn-success:hover {
            background: #229954;
        }

        .dashboard {
            display: none;
        }

        .dashboard.show {
            display: block;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
        }

        .metric-number {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .metric-label {
            font-size: 1.1rem;
            color: #7f8c8d;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }

        .chart-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: #2c3e50;
            text-align: center;
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 20px;
        }

        .insights-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .insight-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            margin: 15px 0;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 10px;
            border-left: 4px solid;
        }

        .insight-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .insight-description {
            font-size: 0.9rem;
            color: #7f8c8d;
        }

        .insight-priority {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .priority-high { background: #e74c3c; color: white; }
        .priority-medium { background: #f39c12; color: white; }
        .priority-low { background: #27ae60; color: white; }

        .loading {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .walkthrough {
            background: rgba(52, 152, 219, 0.1);
            border: 2px solid #3498db;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }

        .walkthrough h3 {
            color: #3498db;
            margin-bottom: 15px;
        }

        .walkthrough ol {
            margin-left: 20px;
        }

        .walkthrough li {
            margin-bottom: 10px;
            color: #555;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .metric-number {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ðŸ§  Safer Campus Intelligence</h1>
            <p>Transform campus safety through data-driven prevention</p>
        </div>

        <!-- Setup Section (Hidden - Auto-connected) -->
        <div class="setup-section" id="setup-section" style="display: none;">
            <h2>ðŸ”§ Quick Setup</h2>
            <p>âœ… Already connected to your Supabase database!</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard show" id="dashboard">
            <button class="btn btn-success" onclick="refreshData()" style="margin-bottom: 20px;">ðŸ”„ Refresh Data</button>

            <!-- Key Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-number" id="total-incidents">-</div>
                    <div class="metric-label">Total Incidents</div>
                    <div class="metric-change positive" id="incidents-trend">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="safety-score">-</div>
                    <div class="metric-label">Safety Score</div>
                    <div class="metric-change positive" id="safety-trend">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="risk-patterns">-</div>
                    <div class="metric-label">Risk Patterns Found</div>
                    <div class="metric-change positive" id="patterns-trend">Loading...</div>
                </div>
                <div class="metric-card">
                    <div class="metric-number" id="prevention-potential">-</div>
                    <div class="metric-label">Prevention Potential</div>
                    <div class="metric-change positive" id="prevention-trend">Loading...</div>
                </div>
            </div>

            <!-- Main Chart -->
            <div class="chart-section">
                <div class="chart-title">ðŸ“Š Safety Intelligence Overview</div>
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
            </div>

            <!-- Actionable Insights -->
            <div class="insights-section">
                <div class="chart-title">ðŸ’¡ What This Data Tells Us</div>
                <div id="insights-list">
                    <div class="loading">Analyzing your data...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Auto-connect with your Supabase credentials
        const SUPABASE_URL = 'https://lhgtiuwbwfvosuapfmay.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoZ3RpdXdid2Z2b3N1YXBmbWF5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM4Nzk0NTYsImV4cCI6MjA2OTQ1NTQ1Nn0.OgWXm2jDuTo3Uz16gEIC1TVzR8QgVlhrHEsef1NN6os';
        
        let supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let mainChart = null;

        // Auto-connected - no form needed

        // Show status messages
        function showStatus(message, type) {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }

        // Load dashboard data
        async function loadDashboard() {
            try {
                // Fetch incidents
                const { data: incidents, error } = await supabaseClient
                    .from('incidents')
                    .select('*')
                    .order('reported_at', { ascending: false });
                
                if (error) throw error;
                
                // Update metrics
                updateMetrics(incidents || []);
                
                // Create main chart
                createMainChart(incidents || []);
                
                // Generate insights
                generateInsights(incidents || []);
                
            } catch (error) {
                console.error('Error loading dashboard:', error);
                document.getElementById('insights-list').innerHTML = 
                    '<div class="error">Error loading data: ' + error.message + '</div>';
            }
        }

        // Update key metrics
        function updateMetrics(incidents) {
            const total = incidents.length;
            const safetyScore = calculateSafetyScore(incidents);
            const riskPatterns = calculateRiskPatterns(incidents);
            const preventionPotential = calculatePreventionPotential(incidents);

            document.getElementById('total-incidents').textContent = total;
            document.getElementById('safety-score').textContent = safetyScore;
            document.getElementById('risk-patterns').textContent = riskPatterns;
            document.getElementById('prevention-potential').textContent = preventionPotential + '%';

            // Mock trends (in real implementation, compare with historical data)
            document.getElementById('incidents-trend').textContent = total > 0 ? 'Data available' : 'No data yet';
            document.getElementById('safety-trend').textContent = safetyScore > 80 ? 'Good' : safetyScore > 60 ? 'Fair' : 'Needs attention';
            document.getElementById('patterns-trend').textContent = riskPatterns > 0 ? 'Patterns detected' : 'No patterns yet';
            document.getElementById('prevention-trend').textContent = preventionPotential > 70 ? 'High potential' : 'Medium potential';
        }

        // Calculate safety score (0-100)
        function calculateSafetyScore(incidents) {
            if (incidents.length === 0) return 100;
            
            const recentIncidents = incidents.filter(i => {
                const date = new Date(i.reported_at);
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                return date > weekAgo;
            });

            if (recentIncidents.length === 0) return 100;
            
            // Simple scoring: fewer incidents = higher score
            const score = Math.max(0, 100 - (recentIncidents.length * 10));
            return Math.round(score);
        }

        // Calculate risk patterns
        function calculateRiskPatterns(incidents) {
            if (incidents.length === 0) return 0;
            
            const patterns = new Set();
            incidents.forEach(incident => {
                const time = new Date(incident.reported_at).getHours();
                const timeSlot = time >= 18 || time <= 6 ? 'Night' : 'Day';
                const pattern = `${incident.incident_type}_${timeSlot}`;
                patterns.add(pattern);
            });
            
            return patterns.size;
        }

        // Calculate prevention potential
        function calculatePreventionPotential(incidents) {
            if (incidents.length === 0) return 100;
            
            const preventionMap = {
                'snake_bite': 80,
                'fire_attack': 90,
                'assault': 70,
                'medical': 60,
                'theft': 80,
                'harassment': 70,
                'vandalism': 80,
                'pickpocketing': 80,
                'other': 50
            };
            
            const avgPotential = incidents.reduce((sum, i) => {
                return sum + (preventionMap[i.incident_type] || 50);
            }, 0) / incidents.length;
            
            return Math.round(avgPotential);
        }

        // Create main chart
        function createMainChart(incidents) {
            const ctx = document.getElementById('mainChart').getContext('2d');
            
            // Group incidents by type
            const typeCounts = incidents.reduce((acc, incident) => {
                acc[incident.incident_type] = (acc[incident.incident_type] || 0) + 1;
                return acc;
            }, {});

            const colors = ['#e74c3c', '#e67e22', '#f39c12', '#27ae60', '#3498db', '#9b59b6'];

            if (mainChart) mainChart.destroy();
            
            mainChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(typeCounts).map(type => type.replace(/_/g, ' ')),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: colors.slice(0, Object.keys(typeCounts).length),
                        borderWidth: 3,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                font: {
                                    size: 14
                                }
                            }
                        }
                    }
                }
            });
        }

        // Generate actionable insights
        function generateInsights(incidents) {
            const insights = [];
            
            if (incidents.length === 0) {
                insights.push({
                    title: "No Data Yet",
                    description: "Start reporting incidents to see insights and patterns",
                    priority: "low"
                });
            } else {
                // Analyze time patterns
                const timeAnalysis = analyzeTimePatterns(incidents);
                if (timeAnalysis.highRiskTime) {
                    insights.push({
                        title: `High Risk Time: ${timeAnalysis.highRiskTime}`,
                        description: `${timeAnalysis.percentage}% of incidents happen during this time. Consider increased security presence.`,
                        priority: "high"
                    });
                }

                // Analyze location patterns
                const locationAnalysis = analyzeLocationPatterns(incidents);
                if (locationAnalysis.hotspot) {
                    insights.push({
                        title: `Safety Hotspot: ${locationAnalysis.hotspot}`,
                        description: `${locationAnalysis.count} incidents reported here. This area needs attention.`,
                        priority: "medium"
                    });
                }

                // Analyze prevention opportunities
                const preventionAnalysis = analyzePreventionOpportunities(incidents);
                if (preventionAnalysis.highPotential > 0) {
                    insights.push({
                        title: "Prevention Opportunities",
                        description: `${preventionAnalysis.highPotential} incidents have high prevention potential. Focus on awareness and monitoring.`,
                        priority: "low"
                    });
                }

                // Overall trend
                const trend = analyzeTrend(incidents);
                if (trend.direction !== 'stable') {
                    insights.push({
                        title: `Safety Trend: ${trend.direction.toUpperCase()}`,
                        description: `Incidents are ${trend.direction} by ${trend.percentage}%. ${trend.direction === 'increasing' ? 'Immediate action needed.' : 'Good progress!'}`,
                        priority: trend.direction === 'increasing' ? 'high' : 'low'
                    });
                }
            }

            // Display insights
            const container = document.getElementById('insights-list');
            container.innerHTML = insights.map(insight => `
                <div class="insight-item" style="border-left-color: ${getPriorityColor(insight.priority)}">
                    <div>
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-description">${insight.description}</div>
                    </div>
                    <div class="insight-priority priority-${insight.priority}">${insight.priority}</div>
                </div>
            `).join('');
        }

        // Helper functions for analysis
        function analyzeTimePatterns(incidents) {
            const timeCounts = { Morning: 0, Afternoon: 0, Evening: 0, Night: 0 };
            
            incidents.forEach(incident => {
                const hour = new Date(incident.reported_at).getHours();
                if (hour >= 6 && hour < 12) timeCounts.Morning++;
                else if (hour >= 12 && hour < 18) timeCounts.Afternoon++;
                else if (hour >= 18 && hour < 22) timeCounts.Evening++;
                else timeCounts.Night++;
            });

            const maxTime = Object.keys(timeCounts).reduce((a, b) => timeCounts[a] > timeCounts[b] ? a : b);
            const maxCount = timeCounts[maxTime];
            const total = incidents.length;

            return {
                highRiskTime: maxCount > total * 0.3 ? maxTime : null,
                percentage: Math.round((maxCount / total) * 100)
            };
        }

        function analyzeLocationPatterns(incidents) {
            const locationCounts = {};
            incidents.forEach(incident => {
                const location = incident.location_description || 'Unknown';
                locationCounts[location] = (locationCounts[location] || 0) + 1;
            });

            const maxLocation = Object.keys(locationCounts).reduce((a, b) => locationCounts[a] > locationCounts[b] ? a : b);
            const maxCount = locationCounts[maxLocation];

            return {
                hotspot: maxCount > 2 ? maxLocation : null,
                count: maxCount
            };
        }

        function analyzePreventionOpportunities(incidents) {
            const preventionMap = {
                'snake_bite': 0.8, 'fire_attack': 0.9, 'assault': 0.7,
                'medical': 0.6, 'theft': 0.8, 'harassment': 0.7,
                'vandalism': 0.8, 'pickpocketing': 0.8, 'other': 0.5
            };

            const highPotential = incidents.filter(i => (preventionMap[i.incident_type] || 0.5) > 0.7).length;
            return { highPotential };
        }

        function analyzeTrend(incidents) {
            const recent = incidents.filter(i => {
                const date = new Date(i.reported_at);
                const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                return date > weekAgo;
            }).length;

            const older = incidents.length - recent;
            const change = recent > older ? 'increasing' : recent < older ? 'decreasing' : 'stable';
            const percentage = Math.abs(Math.round(((recent - older) / Math.max(older, 1)) * 100));

            return { direction: change, percentage };
        }

        function getPriorityColor(priority) {
            const colors = { high: '#e74c3c', medium: '#f39c12', low: '#27ae60' };
            return colors[priority] || '#3498db';
        }

        // Refresh data function
        async function refreshData() {
            if (supabaseClient) {
                await loadDashboard();
            }
        }

        // Auto-load dashboard when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
        });
    </script>
</body>
</html>
